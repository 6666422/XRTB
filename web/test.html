<html>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="Bootstrap static html page for campaign administration."
    name="description">
    <meta content=
    "RTB,OpenRTB,JAVA,Advertising,real-time,campaign,administration" name=
    "keywords">
    <meta content="RTB4FREE" name="author">

    <title>RTB4FREE Admin</title>
    <link href=
    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
    rel="stylesheet">
    <link href=
    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"
    rel="stylesheet">
    <script src=
    "https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src=
    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <style type="text/css">
.bs-example{
        margin: 20px;
    }
    </style>
</head>

 <div class="bs-example">
        <h2>RTB4FREE Campaign Administrator Page</h2>

        <p>This page is used to manage sample campaigns. You need a login to
        actually manage your campaigns. If you already have made a login, type
        the name in here and push the 'Login' button.</p>

        <p>If you don't have a login, simply type the login name you would like
        and push 'Login' and a login will be made for you.</p>

        <p>Be aware that logins expire after 30 days, and your login (and
        campaigns) are deleted unless you login at least once within the 30 day
        period.</p><input id="p_username" placeholder="User name" size="40"
        type="text" value=""> <input id="p_login" onclick="doLogin()" type=
        "button" value="Login"      data-toggle="tooltip" data-placement="bottom" 
        data-original-title="Login to the portal with your login, if not present, it will be created for you
        the first time used."> 
        

        <div id="list-block">
            <hr>
            <input id="ad_domain" placeholder="ad id" size="40" type="text"
            value=""> <input onclick="doDyno();" type='button' value='+'
                data-toggle="tooltip" data-placement="bottom" 
        		data-original-title="This will create a new basic campaign for you to work with."> <br>

            <table id="addinput">
                <tr>
                    <th>Select Campaign to Edit</th>
                </tr>

                <tr id="row0">
                    <td></td>

                    <td></td>
                </tr>
            </table>
        </div>
        <hr>

        <ul class="nav nav-tabs" id="myTab">
            <li class="active">
                <a data-toggle="tab" href="#attributes">Attributes</a>
            </li>

            <li>
                <a data-toggle="tab" href="#templates">Templates</a>
            </li>

            <li>
                <a data-toggle="tab" href="#creatives">Creatives</a>
            </li>

            <li>
                <a data-toggle="tab" href="#constraints">Constraints</a>
            </li>
           <li>
                <a data-toggle="tab" href="#zstatus">Status</a>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade in active" id="attributes">
            
<form role="form" method="get" action="#">
	<div class="form-group">
		<div class="col-lg-2">
			<label for="name">Ad Domain</label>
			<input type="text" class="form-control" id="adomain" placeholder="Enter ad domain" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-lg-2">
			<label for="price">Price</label>
			<input type="text" class="form-control" id="price" placeholder="Price" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-lg-2">
			<label for="adid">Ad Id</label>
			<input type="text" class="form-control" id="adid" placeholder="Ad ID" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-lg-2">
			<label for="startdate">Start Date</label>
			<input type="text" class="form-control" id="startdate" placeholder="Start date" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-lg-2">
			<label for="enddate">End Date</label>
			<input type="text" class="form-control" id="enddate" placeholder="End date" />
		</div>
	</div>

<div class="checkbox">
	<label><input type="checkbox" /> Check me out</label>
</div>
<button type="submit" class="btn btn-default">Submit</button>
</form>
            </div>

            <div class="tab-pane fade" id="templates">
				<div class="form-group">
					<div class="col-lg-2">
						<label for="default">Default</label>
						<input type="text" class="form-control" id="default" placeholder="Default template" />
					</div>
					<br/>

				    <table id="addtemplate">
         				<th>Exchange</th>
         				<th>Template</th>
         					<tr id="row0">
            				<td>
              			 		<input type="text" id="p_new_exchange" size="20" name="p_new_x" value="" placeholder="exchange name" />
            				</td>
            				<td>
               					<input type="text" id="p_new_template" size="100" name="p_new" value="" placeholder="template is here" />
           			 		</td>
            				<td><a href="javascript:doDynoTemplate();">Add</a></td>
         				</tr>
					 </table>
				</div>
           	</div>

            <div class="tab-pane fade" id="creatives">
                <p>We will edit the creatives here</p>

                <p></p>
            </div>

            <div class="tab-pane fade" id="constraints">
 				<table id="addconstraints">
         				<th>Constraint Name</th>
         				<th>Operation</th>
         				<th>Constraint Value</th>
         				<th>Required</th>
         					<tr id="row0">
            				<td>
              			 		<input type="text" id="p_new_constraint" size="40" name="p_new_constraint" value="" placeholder="constraint" />
            				</td>
            				<td>
            				
<select class='form-control' id='opselect'>
<option value='EQUALS'>EQUALS</option>
<option value='NOT_EQUALS'>NOT_EQUALS</option>
<option value='MEMBER'>MEMBER</option>
<option value='NOT_MEMBER'>NOT_MEMBER</option>
<option value='INTERSECTS'>INTERSECTS</option>
<option value='NOT_INTERSECTS'>NOT_INTERSECTS</option>
<option value='INRANGE'>INRANGE</option>
<option value='NOT_INRANGE'>NOT_INRANGE</option>
<option value='LESS_THAN'>LESS_THAN</option>
<option value='LESS_THAN_EQUALS'>LESS_THAN_EQUALS</option>
<option value='GREATER_THAN'>GREATER_THAN</option>
<option value='GREATER_THAN_EQUALS'>GREATER_THAN_EQUALS</option>
<option value='DOMAIN'>DOMAIN</option>
<option value='NOT_DOMAIN'>NOT_DOMAIN</option>
</select>
            				</td>
            				<td>
               					<input type="text" id="p_new_value" size="40" name="p_new_values" value="" placeholder="values are here" />
           			 		</td>
           			 		<td><input type="CHECKBOX" id="p_required" checked></td>
           			 		
            				<td><a href="javascript:addNewConstraint();">Add</a></td>
         				</tr>
					 </table>
            </div>
            
            <div class="tab-pane fade" id="zstatus">
				<table id="addstatus" rules='all'>
                <tr>
                    <th>Campaign/th>
                    <th>Action</th>
                </tr>

                <tr id="row0">
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </div>
          <input type="button" id="save_to_host" value="Upload Changes" onclick="saveChanges()"/>
        </div>
    </div>
</body>

<script>

$(document).ready(function(){
    $(".tip-top").tooltip({placement : 'top'});
    $(".tip-right").tooltip({placement : 'right'});
    $(".tip-bottom").tooltip({placement : 'bottom'});
    $(".tip-left").tooltip({ placement : 'left'});
});

$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();   
});



       function DynamicTable(tableId, cells) {
           this.tableId = tableId;
           this.cells = cells;
           this.headers = document.getElementById(tableId).rows.length;
       }
       
       DynamicTable.prototype.clear = function() {
        	var table = document.getElementById(this.tableId);
			while(table.rows.length>this.headers) {
               table.deleteRow(this.headers);
            }
        }
        
        DynamicTable.prototype.macroSubs = function(line,a,rowCount,idr,col) {
        	line = line.replace(/SUB_VALUE/g, a);
            line = line.replace(/SUB_ID/g, this.tableId+":"+col+":"+rowCount);
            line = line.replace(/ROW_ID/g, idr);    
            return line;
        }
        
        DynamicTable.prototype.remove = function(what) {
         	var id=  this.tableId;
            var table = document.getElementById(id);
            for (var i = 0; i < table.rows.length; i++) {
                           row = table.rows[i];
                           id = row.getAttribute("id");
                           if (id == what) {
                               table.deleteRow(i);
                               return;
                           }
                       }
        }
        
         DynamicTable.prototype.add = function(values) {
        		   var id=  this.tableId;
                   var table = document.getElementById(id);
                   var rowCount = table.rows.length + 1;
                   var row = table.insertRow(-1);
                   var label = id + rowCount;
                   row.setAttribute("id", id + rowCount);
                       
                   for (var i = 0; i < this.cells.length; i++) {
                   		var cell = row.insertCell(i);
                        cell.innerHTML = this.macroSubs(this.cells[i],values[i],rowCount,id+rowCount,i);
                       	obj = document.getElementById(this.tableId+":"+i+":"+rowCount);
                       	
                       	if (obj != null) {
                       		if (obj.tagName == "SELECT") {
                       			for(var j=0; j < obj.options.length; j++) {           			
    								if(obj.options[j].value === values[i]) {
      									obj.selectedIndex = j;
      									break;
   									 }
  								}
                       		} else {
                       			if (obj.type == "checkbox") {
                       				obj.checked = values[i];
                       			} else
                       		 		obj.value = values[i];
                       		 }
                       	}
                       		 
                        console.log(cell.innerHTML);
                   }
                   return label;
           }
           
       function doLogin() {
        clearFields();
        
        name = document.getElementById('p_username').value;
        if (name == "")
        	return;
        	
        data = {
        command: 'login',
        username: name
        };

        $.ajax({
         type: 'POST',
         url:'ajax',
         data: JSON.stringify(data),
         dataType: 'json',
         success: function(data, textStatus, request){
           if (request.status == 204) {
            text = "";
           } else {
            text = request.responseText;
            data = JSON.parse(text);
            
            camps = data.campaigns;
            message = data.message;
            text = JSON.stringify(data,null,2);
            
         
           }
         //  console.log("data = " + JSON.stringify(camps,null,2));
           if (message != null && message != "")
                alert(message);
               
           for (i=0;i<camps.length;i++) {
                campaign = camps[i];
                dyno.add([campaign.adId,'']);
                value = campStatus.add([campaign.adId,'']);
                console.log("ADDED: " + value);
           }
           updateStatus();

         },
         error: function (request, textStatus, errorThrown) {
           alert("Error: " + request.responseText);
         }});
        }     
        
        function doDyno() {
            var newName = document.getElementById("ad_domain").value;

            if (newName == '') {
                alert("Error: Can't have a blank ad domain");
                return;
            }
            
            ///////////////////////////////////////////////////
               data = {
                    command: 'stub',
                username: document.getElementById('p_username').value,
                campaign: newName
            };

        $.ajax({
         type: 'POST',
         url:'ajax',
         data: JSON.stringify(data),
         dataType: 'json',
         success: function(data, textStatus, request){
           if (request.status == 204) {
            text = "";
           } else {
            text = request.responseText;
            data = JSON.parse(text);
            
            camp = data.campaign;
            camps.push(camp);
            message = data.message;
            text = JSON.stringify(data,null,2);
         
           }
         //  console.log("data = " + JSON.stringify(camps,null,2));
           if (message != null && message != "")
                alert(message);
               
            dyno.add([camp.adId,'']);
            document.getElementById("ad_domain").value = "";
           

         },
         error: function (request, textStatus, errorThrown) {
           alert("Error: " + request.responseText);
         }});
            
            ////////////////////////////////////////////////////
            
            
         }
         
function updateStatus() {
	
}

function getCampaign(id) {
	for (camp in camps) {
		if (camp.adId == id)
			return camp;
	}
	return null;
}
        
function clearFields() {
	dyno.clear();
	tdyno.clear();
	campStatus.clear();
	cdyno.clear();
}
           

function deleteCampaign(what,id) {
	var parts = id.split(":");
	var celln = Number(parts[1])-1; 
	celln = parts[0] + ":" + celln +":" + parts[2];
	var value = document.getElementById(celln).value;
	console.log("REMOVE VAL: " + value);
	//////////////////
      ///////////////////
               data = {
                    command: 'deletecampaign',
                username: document.getElementById('p_username').value,
                campaign: value
            };
        $.ajax({
         type: 'POST',
         url:'ajax',
         data: JSON.stringify(data),
         dataType: 'json',
         success: function(data, textStatus, request){
           if (request.status == 204) {
            text = "";
           } else {
            text = request.responseText;
            data = JSON.parse(text);
            if (data.campaigns != null) {
                camps = data.campaigns;
            }
            message = data.message;
            text = JSON.stringify(data,null,2);
            console.log("-----------------");
            console.log(text);
           }
           if (message != null && message != "")
                alert(message);
               
            dyno.remove(what);
         },
         error: function (request, textStatus, errorThrown) {
           alert("Error: " + request.responseText);
         }});
        //////////////////
	//////////////////
}

function processCampaign(what) {
	var x = document.getElementById(what).value;
	console.log("PROCESS WHAT: " + x);
	for(var i=0;i<camps.length;i++) {
        var c = camps[i];
        if (c.adId == x) {
            document.getElementById("adomain").value = c.adomain;
            document.getElementById("price").value = c.price;
            document.getElementById("adid").value = c.adId;
            document.getElementById("startdate").value = c.date[0];
            document.getElementById("enddate").value = c.date[1];
            
            document.getElementById("default").value = c.template.default;
            
            var exchange = c.template.exchange;
            tdyno.clear();
            for (var p in exchange) {
    			if( exchange.hasOwnProperty(p) ) {
    				tdyno.add([p,exchange[p],'']);
    			} 
  			}  
  			
  			cdyno.clear();
  			for (i = 0; i < c.attributes.length; i++) {
  				var attribute = c.attributes[i];
  				var left = "";
  				for (j = 0; j < attribute.bidRequestValues.length;j++) {
  					left += attribute.bidRequestValues[j];
  					if (j+1 < attribute.bidRequestValues.length)
  						left += ".";
  				}
  				var op = attribute.op;
  				var right = JSON.stringify(attribute.value);
  				var req = c.required;
  				cdyno.add([left,op,right,req,""]);
  				console.log(JSON.stringify(attribute,null,2));
  			}                          
        }
    }
}

function deleteTemplateRow(what) {
	console.log("DELETE WHAT: " + what);
	x = document.getElementById(what);
	console.log("val = " + x.value);
	tdyno.remove(what);
}

function deleteConstraintRow(what) {
	console.log("DELETE WHAT: " + what);
	x = document.getElementById(what);
	console.log("val = " + x.value);
	cdyno.remove(what);
}

function addTemplateRow(id1, id2) {
	o = document.getElementById(id1);
	vals = [];
	vals.push(o.value);
	o.value = "";
	o = document.getElementById(id2);
	vals.push(o.value);
	o.value = "";
	vals.push("");
	tdyno.add(vals); 
}

function addNewConstraint() {
	a = document.getElementById("p_new_constraint");
	op = document.getElementById("opselect");
	b = document.getElementById("p_new_value");
	req = document.getElementById("p_required").checked;
	vals = [];
	vals.push(a.value);
	vals.push(op.value);
	vals.push(b.value);
	vals.push(req);
	vals.push("");
	cdyno.add(vals);
}

function startStop(rowId) {
	console.log("A="+rowId);
	row = document.getElementById(rowId);
	cell = row.cells[0];
	a = cell.textContent;
	cell = row.cells[1];
	inp = cell.children[0];
	b = inp.value;
	if (b == 'Start')
		inp.value='Pending...';
}

camps = [];

cells = [];
cells.push( "<input type='button' onclick='processCampaign(\"SUB_ID\")' value='SUB_VALUE' id='SUB_ID' class='primary-btn col-xs-11 text-left' style=\"width:280px\">");
cells.push( "<a href=\"javascript:deleteCampaign('ROW_ID','SUB_ID');\">Del<\/a>");
      
dyno = new DynamicTable("addinput",cells);

zcells = [];
zcells.push('SUB_VALUE')
zcells.push("<input type='button' onclick='startStop(\"ROW_ID\")' value='Start' id='ROW_ID' class='primary-btn col-xs-11 text-left' style=\"width:100px\"/>");
campStatus = new DynamicTable("addstatus",zcells);


////////////////////////////////////

xcells = [];
xcells.push("<input type='text' id='SUB_ID' size='20'value='' placeholder='exchange name' />");
xcells.push("<input type='text' id='SUB_ID' size='100' value='' placeholder='template is here' />");
xcells.push("<a href=\"javascript:deleteTemplateRow('ROW_ID');\">Del</a></td>");

tdyno = new DynamicTable("addtemplate",xcells);

ccells = [];

ccells.push("<input type='text' id='SUB_ID' size='40'value='' placeholder='constraint name' />")
ccells.push("<select class='form-control' id='SUB_ID'>"+
"<option value='EQUALS'>EQUALS</option>"+
"<option value='NOT_EQUALS'>NOT_EQUALS</option>"+
"<option value='MEMBER'>MEMBER</option>"+
"<option value='NOT_MEMBER'>NOT_MEMBER</option>"+
"<option value='INTERSECTS'>INTERSECTS</option>"+
"<option value='NOT_INTERSECTS'>NOT_INTERSECTS</option>"+
"<option value='INRANGE'>INRANGE</option>"+
"<option value='NOT_INRANGE'>NOT_INRANGE</option>"+
"<option value='LESS_THAN'>LESS_THAN</option>"+
"<option value='LESS_THAN_EQUALS'>LESS_THAN_EQUALS</option>"+
"<option value='GREATER_THAN'>GREATER_THAN</option>"+
"<option value='GREATER_THAN_EQUALS'>GREATER_THAN_EQUALS</option>"+
"<option value='DOMAIN'>DOMAIN</option>"+
"<option value='NOT_DOMAIN'>NOT_DOMAIN</option>"+
"</select>")
ccells.push("<input type='text' id='SUB_ID' size='40'value='' placeholder='constraint value' />")
ccells.push("<input type='checkbox' id='SUB_ID' checked>");
ccells.push("<a href=\"javascript:deleteConstraintRow('ROW_ID');\">Del</a></td>");

cdyno = new DynamicTable("addconstraints",ccells);

</script>

</html>